---
title: "Working with Rates"
format: html
date: October 21, 2025
editor: visual
---

## Set up
```{r}
rm(list=ls())
library(here)
library(tidyverse)
# libraries that Jackie had loaded
library(pscl)
library(multcomp)
library(emmeans)
library(broom)
```

### Load data
```{r}
# the updated dataset with only the rows that has seconds format possible
bird <- read.csv(here("Data/Bird_edited.csv"))
```

```{r}
hierarchy_fct <- c("Phleg", "M. fort", "Rheg", "D. mer", "G. sal") # most dominant to least dominant - this hierarchy leveling is correct
```
```{r}
# use the factor created above to make dataset with that applied
bird <- bird |> mutate(species = factor(species, hierarchy_fct))
```
```{r}
levels(bird$species)
```

## My thoughts and questions
- Can I still use the true/false and make the line plots with an offset?
- I made a new column from the duration column with just seconds so it's in integer form
- Including density - would need to do a bunch of filtering I think? Best way to do this? considering that the obsid column has date (year, month, day) and person

## Offset
### Rintra
```{r}
offset1_Rintra <- glm.nb(Successes ~ species + Ind_Rintra + species*Ind_Rintra + offset(log(duration_seconds)), data = bird)

summary(offset1_Rintra)
# the offset worked!!

# offset2_Rintra <- glm.nb(Successes ~ species + Rintra + species*Rintra, data = bird, offset = log(bird$duration_seconds))
```


```{r}
# next part from ReRun qmd - look at this plot - might not work here
emmip(offset1_Rintra, species ~ Ind_Rintra | Ind_Rintra)

# This worked, but I'm not quite sure what it means
```

```{r}
#sort(log(bird_no_na$duration_seconds +1)) |> head() 
#sum(is.na(bird$duration_seconds))
```



## Filter one species
```{r}
# filter to just one species - start with D.mer

Dmer_bird <- bird |>
  filter(species == "D. mer")

Phleg_bird <- bird |>
  filter(species == "Phleg")

#change duration_seconds to numeric in case that was why couldn't find it for an offset... didn't work


```

```{r}
offset_Dmer_Rintra <- glm.nb(Successes ~ Ind_Rintra + attempts + Ind_Rintra:attempts + offset(log(duration_seconds)), data = Dmer_bird) 

# offset1_Rintra <- glm.nb(Successes ~ species + Ind_Rintra + species*Ind_Rintra + offset(log(duration_seconds)), data = bird)
```



## Zero Inflated Poisson

```{r}
ggplot(aes(x = Successes), data = Dmer_bird)+
  geom_bar()

ggplot(aes(x = Successes), data = bird)+
  geom_bar()

ggplot(aes(x = Successes), data = Phleg_bird)+
  geom_bar()

# these do seem like candidates for zero-inflated poisson models
```
Thoughts
- is there 2 clear groups? each bird has equal chance of success, but might be stopped by bullying - which is what we're trying to figure out. but they could also not have any bullying and be unsuccessful


### Part 1 - the poisson regression part
model the number of successes amongst birds who are successful

include duration_seconds here
attempts
Rintra - value or yes/no? - maybe include, maybe not



### Part 2 - the logistic regression part/zero inflation part
model the probability that a bird is not successful

include duration_seconds here
include Rintra or Ind_Rintra here

### code
```{r}
ZIPmod_Dmer <- zeroinfl(Successes ~ attempts + duration_seconds|Ind_Rintra + duration_seconds, data = Dmer_bird, dist = "poisson")

# now thinking that attempts and successes is way too correlated to use that as a predictor - do something else *******************

# worked
summary(ZIPmod_Dmer)


#### OLD #####
# got error message - system is computationally singular.... 
# googled and says could be issues with multicolinearity, overfitting, zero variance 
###############
```


```{r}
#correlation matrix
cor(Dmer_bird)
# saying x must be numeric - why?
```



